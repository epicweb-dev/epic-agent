name: ðŸŒ™ Nightly Workshop Reindex

on:
  schedule:
    # 03:00 Mountain Standard Time (UTC-7). Note this shifts to 04:00 during DST.
    - cron: '0 10 * * *'
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  nightly-workshop-reindex:
    name: ðŸŒ™ ðŸ§  Nightly workshop reindex
    runs-on: ubuntu-latest
    concurrency:
      group: workshop-content-load-nightly-production
      cancel-in-progress: false
    timeout-minutes: 60
    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ðŸ§° Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: ðŸ“¥ Install dependencies
        run: bun install --frozen-lockfile

      - name: ðŸ”Ž Detect workshop updates and reindex
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN || github.token }}
          TARGET_ENVIRONMENT: production
          WORKSHOP_BATCH_SIZE: 2
          WORKSHOP_VECTORIZE_INDEX_NAME:
            ${{ secrets.WORKSHOP_VECTORIZE_INDEX_NAME }}
          WORKSHOP_VECTORIZE_INDEX_NAME_PREVIEW:
            ${{ secrets.WORKSHOP_VECTORIZE_INDEX_NAME_PREVIEW }}
          EPICSHOP_AUTH_INFOS: ${{ secrets.EPICSHOP_AUTH_INFOS }}
        run: bun tools/workshop-content-load-nightly.ts
