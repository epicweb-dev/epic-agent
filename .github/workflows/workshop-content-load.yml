name: ðŸ§  Load Workshop Content

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Target Cloudflare environment
        required: true
        default: production
        type: choice
        options:
          - production
          - preview
      workshops:
        description:
          Optional comma/newline-separated workshop slugs. Leave empty to index
          all.
        required: false
        default: ''
      batchSize:
        description: Workshops processed per request (1-20)
        required: false
        default: 2
        type: number

permissions:
  contents: read

jobs:
  load-workshop-content:
    name: ðŸ§  Reindex workshops into D1 + Vectorize
    runs-on: ubuntu-latest
    concurrency:
      group: workshop-content-load-${{ inputs.environment }}
      cancel-in-progress: false
    timeout-minutes: 45
    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ðŸ§° Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: ðŸ“¥ Install Dependencies
        run: bun install --frozen-lockfile

      - name: ðŸšš Load workshop content into D1 and Vectorize
        env:
          WORKSHOP_LIST_INPUT: ${{ inputs.workshops }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN || github.token }}
          TARGET_ENVIRONMENT: ${{ inputs.environment }}
          WORKSHOP_BATCH_SIZE: ${{ inputs.batchSize }}
          WORKSHOP_VECTORIZE_INDEX_NAME:
            ${{ secrets.WORKSHOP_VECTORIZE_INDEX_NAME }}
          WORKSHOP_VECTORIZE_INDEX_NAME_PREVIEW:
            ${{ secrets.WORKSHOP_VECTORIZE_INDEX_NAME_PREVIEW }}
          EPICSHOP_AUTH_INFOS: ${{ secrets.EPICSHOP_AUTH_INFOS }}
        run: bun tools/workshop-content-load-from-clones.ts
