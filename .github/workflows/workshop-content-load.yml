name: ðŸ§  Load Workshop Content

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Target Cloudflare environment
        required: true
        default: production
        type: choice
        options:
          - production
          - preview
      workshops:
        description:
          Optional comma/newline-separated workshop slugs. Leave empty to index
          all.
        required: false
        default: ''

permissions:
  contents: read

jobs:
  load-workshop-content:
    name: ðŸ§  Reindex workshops into D1 + Vectorize
    runs-on: ubuntu-latest
    concurrency:
      group: workshop-content-load-${{ inputs.environment }}
      cancel-in-progress: false
    timeout-minutes: 45
    steps:
      - name: ðŸ”Ž Resolve target environment URL
        id: target
        env:
          TARGET_ENVIRONMENT: ${{ inputs.environment }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
          APP_BASE_URL_PREVIEW: ${{ secrets.APP_BASE_URL_PREVIEW }}
        run: |
          set -euo pipefail

          if [ "$TARGET_ENVIRONMENT" = "preview" ]; then
            TARGET_URL="${APP_BASE_URL_PREVIEW:-$APP_BASE_URL}"
          else
            TARGET_URL="$APP_BASE_URL"
          fi

          TARGET_URL="$(printf '%s' "$TARGET_URL" | sed 's/^[[:space:]]*//; s/[[:space:]]*$//')"
          TARGET_URL="${TARGET_URL%/}"
          if [ -z "$TARGET_URL" ]; then
            echo "Missing APP_BASE_URL secret (and APP_BASE_URL_PREVIEW for preview)." >&2
            exit 1
          fi
          if ! printf '%s' "$TARGET_URL" | grep -Eq '^https?://'; then
            echo "Target URL must start with http:// or https://." >&2
            exit 1
          fi

          echo "target_url=$TARGET_URL" >> "$GITHUB_OUTPUT"

      - name: ðŸ” Verify admin token
        env:
          WORKSHOP_INDEX_ADMIN_TOKEN: ${{ secrets.WORKSHOP_INDEX_ADMIN_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "$WORKSHOP_INDEX_ADMIN_TOKEN" ]; then
            echo "Missing WORKSHOP_INDEX_ADMIN_TOKEN secret." >&2
            exit 1
          fi

      - name: ðŸšš Load workshop content into D1 and Vectorize
        env:
          TARGET_URL: ${{ steps.target.outputs.target_url }}
          WORKSHOP_INDEX_ADMIN_TOKEN: ${{ secrets.WORKSHOP_INDEX_ADMIN_TOKEN }}
          WORKSHOP_LIST_INPUT: ${{ inputs.workshops }}
          TARGET_ENVIRONMENT: ${{ inputs.environment }}
        run: |
          set -euo pipefail

          if [ -n "$WORKSHOP_LIST_INPUT" ]; then
            WORKSHOPS_JSON=$(printf '%s' "$WORKSHOP_LIST_INPUT" | jq -R -s 'gsub("[\\r\\n]+"; ",") | split(",") | map(gsub("^\\s+|\\s+$"; "")) | map(ascii_downcase) | map(select(length > 0)) | unique')
            WORKSHOP_COUNT_INPUT=$(printf '%s' "$WORKSHOPS_JSON" | jq -r 'length')
            if [ "$WORKSHOP_COUNT_INPUT" -gt 100 ]; then
              echo "workshops input must contain at most 100 unique slugs after normalization." >&2
              exit 1
            fi
            if [ "$WORKSHOP_COUNT_INPUT" -gt 0 ]; then
              PAYLOAD=$(jq -nc --argjson workshops "$WORKSHOPS_JSON" '{ workshops: $workshops }')
            else
              PAYLOAD='{}'
            fi
          else
            PAYLOAD='{}'
          fi

          RESPONSE_FILE=$(mktemp)
          HTTP_STATUS=$(
            curl --silent --show-error \
              --retry 3 \
              --retry-all-errors \
              --retry-delay 2 \
              --connect-timeout 15 \
              --max-time 300 \
              --output "$RESPONSE_FILE" \
              --write-out '%{http_code}' \
              --request POST \
              --url "$TARGET_URL/internal/workshop-index/reindex" \
              --header "Authorization: Bearer $WORKSHOP_INDEX_ADMIN_TOKEN" \
              --header 'Content-Type: application/json' \
              --data "$PAYLOAD"
          )

          RESPONSE_BODY=$(<"$RESPONSE_FILE")
          echo "Reindex response: $RESPONSE_BODY"

          if ! printf '%s' "$RESPONSE_BODY" | jq -e . >/dev/null; then
            echo "Workshop content load returned non-JSON response." >&2
            exit 1
          fi

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Workshop content load failed with HTTP $HTTP_STATUS" >&2
            exit 1
          fi

          RESPONSE_OK=$(printf '%s' "$RESPONSE_BODY" | jq -r '.ok // false')
          if [ "$RESPONSE_OK" != "true" ]; then
            ERROR_MESSAGE=$(printf '%s' "$RESPONSE_BODY" | jq -r '.error // "unknown error"')
            echo "Workshop content load reported failure: $ERROR_MESSAGE" >&2
            exit 1
          fi

          WORKSHOP_COUNT=$(printf '%s' "$RESPONSE_BODY" | jq -r '.workshopCount // 0')
          EXERCISE_COUNT=$(printf '%s' "$RESPONSE_BODY" | jq -r '.exerciseCount // 0')
          STEP_COUNT=$(printf '%s' "$RESPONSE_BODY" | jq -r '.stepCount // 0')
          SECTION_COUNT=$(printf '%s' "$RESPONSE_BODY" | jq -r '.sectionCount // 0')
          SECTION_CHUNK_COUNT=$(printf '%s' "$RESPONSE_BODY" | jq -r '.sectionChunkCount // 0')
          RUN_ID=$(printf '%s' "$RESPONSE_BODY" | jq -r '.runId // "unknown"')
          REQUESTED_WORKSHOPS=$(printf '%s' "$PAYLOAD" | jq -r '.workshops // [] | join(", ")')

          {
            echo "## Workshop content load complete"
            echo ""
            echo "- Environment: $TARGET_ENVIRONMENT"
            echo "- Target URL: $TARGET_URL"
            if [ -n "$REQUESTED_WORKSHOPS" ]; then
              echo "- Requested workshops: $REQUESTED_WORKSHOPS"
            else
              echo "- Requested workshops: all discovered workshop repositories"
            fi
            echo "- Reindex run id: $RUN_ID"
            echo "- Workshop count: $WORKSHOP_COUNT"
            echo "- Exercise count: $EXERCISE_COUNT"
            echo "- Step count: $STEP_COUNT"
            echo "- Section count: $SECTION_COUNT"
            echo "- Section chunk count: $SECTION_CHUNK_COUNT"
          } >> "$GITHUB_STEP_SUMMARY"
